<!DOCTYPE html>
<html lang="en">
<script src="//cdn.jsdelivr.net/npm/vconsole@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<!--<script src="https://cdn.jsdelivr.net/npm/cdnbye@latest"></script>-->
<script src="./dist/ios-p2p-engine.min.js"></script>
<head>
    <meta charset="UTF-8">
    <title>iOS</title>
</head>
<video id="video" controls></video>
<p id="version"></p>
<h3>download info:</h3>
<p id="info"></p>
<table id="table-body">
    <tbody ></tbody>
</table>
<script>
    var vConsole = new VConsole();
    var ios = new P2PEngineIOS({
        // announce: "http://127.0.0.1/v1",
        // useHttpRange: true,
        // 测试环境
        logLevel: 'debug',
        // p2pEnabled: false,
        trickleICE: true,
        // nativePlaybackOnly: true,
        // scheduledBySegId: true,
    })

    ios.registerServiceWorker().then(function (registration) {
        console.info('ServiceWorker registration successful with scope: ', registration.scope);
    }).catch((err) => {
        console.info('ServiceWorker registration failed ', err)
    })

    ios.on('FRAG_LOADED', (url, frag, byP2p) => {
        // console.warn(`FRAG_LOADED ${url}`)
        var source = 'HTTP';
        if (byP2p) {
            source = 'P2P';
        }
        addToTable(frag.relurl, frag.loaded, source, frag.fromPeerId);
    });
    ios.on('stats', function ({totalHTTPDownloaded=0, totalP2PDownloaded=0, totalP2PUploaded=0}) {
        var total = totalHTTPDownloaded + totalP2PDownloaded;
        document.querySelector('#info').innerText = `p2p ratio: ${Math.round(totalP2PDownloaded/total*100)}%, saved traffic: ${totalP2PDownloaded}KB, uploaded data: ${totalP2PUploaded}KB`;
    });

    // var url = 'https://wowza.peer5.com/live/smil:bbb_abr.smil/chunklist_b591000.m3u8';
    // var url = 'https://storage.googleapis.com/wvtemp/rkuroiwa/hls_single_segment/sintel_1080p_single_segment.m3u8';  // range mp4
    // var url = 'https://global.bongobd.com/vod/vod/S/D/SDVFt8B4EE7/SDVFt8B4EE7_720p.m3u8';  // range ts
    // var url = 'https://wowza.peer5.com/live/smil:bbb_abr.smil/playlist.m3u8';
    // var url = 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8';
    var url = 'https://video.cdnbye.com/0cf6732evodtransgzp1257070836/e0d4b12e5285890803440736872/v.f100220.m3u8';
    // var url = 'http://v.live.hndt.com/video/20200317/9411f6c1f11b44888294d47d73107641/cloudv-transfer/555555555po0q1sn5556526553738q1r_73ac26e878d047498fa906ef9e913036_0_4.m3u8';

    hls = start(url);
    function start(url) {

        var video = document.getElementById('video');
        video.muted = true
        var hls = new Hls({
            maxBufferSize: 0,
            maxBufferLength: 5,
            maxMaxBufferLength: 10,
            // debug: true,
            // "lowLatencyMode": true,
        });
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED,function(event, data) {
            video.play();
        });
        return hls
    }

    // setTimeout(() => {
    //     stop(hls)
    //     hls = start('https://video.cdnbye.com/0cf6732evodtransgzp1257070836/e0d4b12e5285890803440736872/v.f100220.m3u8')
    // }, 10000)

    function stop(hls) {
        hls.stopLoad()
        hls.detachMedia()
        hls.destroy()
        hls = null
    }

    document.querySelector('#version').innerText = `SDK version: ${P2PEngineIOS.version} MSE: ${P2PEngineIOS.isMSESupported()} WebRTC: ${P2PEngineIOS.isWebRTCSupported()} SW: ${P2PEngineIOS.isSeviceWorkerSupported()}`;
    function addToTable(url, downloaded, source, fromPeerId) {
        var fromPeer = fromPeerId ? `from ${fromPeerId}` : ``;
        var infoStr = `download ${url}(size:${downloaded}B) by ${source} ${fromPeer}`;
        document.querySelector('#table-body tbody').innerHTML +=
            `<tr style="text-align: center">
                    <td>${infoStr}</td>
                </tr>`
    }

</script>

</html>
